<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åšå®¢ç®¡ç† | Kuan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{--primary:#00d9ff;--primary-soft:rgba(0,217,255,0.15);--secondary:#00ff87;--accent:#b400ff;--bg-dark:#0d0d14;--bg-card:rgba(255,255,255,0.04);--bg-card-hover:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.1);--border-hover:rgba(0,217,255,0.4);--text-primary:#f0f0f5;--text-secondary:#8a8aa0;--text-muted:#5a5a70;--danger:#ff4757;--danger-soft:rgba(255,71,87,0.15);--success:#00ff87;--success-soft:rgba(0,255,135,0.15);--warning:#ffa502;--warning-soft:rgba(255,165,2,0.15)}
    [data-theme="light"]{--primary:#0099cc;--primary-soft:rgba(0,153,204,0.12);--secondary:#00cc66;--accent:#9933cc;--bg-dark:#f8f9fc;--bg-card:rgba(255,255,255,0.9);--bg-card-hover:rgba(255,255,255,1);--border:rgba(0,0,0,0.1);--border-hover:rgba(0,153,204,0.4);--text-primary:#1a1a2e;--text-secondary:#5a5a70;--text-muted:#8a8aa0}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Outfit',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;line-height:1.6;transition:background 0.4s,color 0.4s}
    .bg-gradient{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:0.3}
    .bg-gradient::before{content:'';position:absolute;top:-30%;left:-30%;width:60%;height:60%;background:radial-gradient(circle,var(--primary) 0%,transparent 50%)}
    [data-theme="light"] .bg-gradient{opacity:0.1}
    .header{position:sticky;top:0;z-index:100;background:var(--bg-dark);border-bottom:1px solid var(--border);backdrop-filter:blur(20px)}
    [data-theme="light"] .header{background:rgba(248,249,252,0.95)}
    .header-inner{max-width:1400px;margin:0 auto;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:0.75rem;text-decoration:none;color:var(--text-primary)}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
    .logo-text{font-weight:700;font-size:1.25rem}
    .logo-text span{color:var(--primary)}
    .header-actions{display:flex;align-items:center;gap:1rem}
    .btn{padding:0.6rem 1.25rem;border-radius:10px;font-size:0.85rem;font-weight:500;cursor:pointer;transition:all 0.3s;text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;border:none;font-family:inherit}
    .btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
    .btn-ghost:hover{color:var(--text-primary);border-color:var(--border-hover);background:var(--bg-card)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#000;font-weight:600}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,217,255,0.3)}
    .btn-danger{background:var(--danger-soft);color:var(--danger);border:1px solid var(--danger)}
    .btn-danger:hover{background:var(--danger);color:#fff}
    .btn-success{background:var(--success-soft);color:var(--success);border:1px solid var(--success)}
    .btn-success:hover{background:var(--success);color:#000}
    .btn-warning{background:var(--warning-soft);color:var(--warning);border:1px solid var(--warning)}
    .btn-warning:hover{background:var(--warning);color:#000}
    .btn-sm{padding:0.4rem 0.85rem;font-size:0.8rem}
    .theme-btn{width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
    .theme-btn:hover{border-color:var(--border-hover);color:var(--text-primary)}
    .main{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:2rem}
    .tabs{display:flex;gap:0.5rem;margin-bottom:2rem;background:var(--bg-card);padding:0.5rem;border-radius:14px;border:1px solid var(--border)}
    .tab{padding:0.75rem 1.5rem;border-radius:10px;font-size:0.9rem;font-weight:500;cursor:pointer;transition:all 0.3s;background:transparent;border:none;color:var(--text-secondary);display:flex;align-items:center;gap:0.5rem}
    .tab:hover{color:var(--text-primary);background:var(--bg-card-hover)}
    .tab.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#000}
    .tab-badge{background:var(--danger);color:#fff;padding:0.15rem 0.5rem;border-radius:10px;font-size:0.7rem;font-weight:600}
    .tab.active .tab-badge{background:rgba(0,0,0,0.3)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .auth-section{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:2rem;margin-bottom:2rem}
    .auth-title{font-size:1.1rem;font-weight:600;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
    .auth-form{display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end}
    .form-group{flex:1;min-width:200px}
    .form-label{display:block;font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.5rem}
    .form-input{width:100%;padding:0.75rem 1rem;background:var(--bg-card-hover);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:0.9rem;font-family:inherit;transition:all 0.3s}
    .form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-soft)}
    .form-textarea{min-height:100px;resize:vertical}
    .auth-status{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:8px;font-size:0.85rem}
    .auth-status.connected{background:var(--success-soft);color:var(--success)}
    .auth-status.disconnected{background:var(--danger-soft);color:var(--danger)}
    .panel-layout{display:grid;grid-template-columns:350px 1fr;gap:2rem}
    @media(max-width:1024px){.panel-layout{grid-template-columns:1fr}}
    .panel{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .panel-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .panel-title{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
    .panel-body{max-height:calc(100vh - 350px);overflow-y:auto}
    .blog-list-item{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);cursor:pointer;transition:all 0.3s}
    .blog-list-item:hover{background:var(--bg-card-hover)}
    .blog-list-item.active{background:var(--primary-soft);border-left:3px solid var(--primary)}
    .blog-list-title{font-weight:500;margin-bottom:0.35rem;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
    .blog-list-meta{font-size:0.75rem;color:var(--text-muted)}
    .empty-list{padding:3rem;text-align:center;color:var(--text-muted)}
    .empty-list-icon{font-size:2.5rem;margin-bottom:1rem;opacity:0.5}
    .editor-panel{display:flex;flex-direction:column}
    .editor-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
    .editor-title-input{flex:1;min-width:200px;padding:0.75rem 1rem;background:var(--bg-card-hover);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:1.1rem;font-weight:600;font-family:inherit}
    .editor-title-input:focus{outline:none;border-color:var(--primary)}
    .editor-meta{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
    .editor-meta .form-group{flex:none;min-width:auto}
    .editor-meta .form-input{padding:0.5rem 0.75rem;font-size:0.85rem}
    .tags-input{min-width:250px}
    .editor-body{flex:1;display:flex;min-height:400px;overflow:hidden}
    .editor-pane{display:flex;flex-direction:column;border-right:1px solid var(--border);flex:1;min-width:0;transition:flex 0.3s ease}
    .editor-pane:last-child{border-right:none}
    .editor-pane.full-width{flex:2}
    .editor-pane.hidden{display:none}
    .pane-header{padding:0.75rem 1rem;background:var(--bg-card-hover);border-bottom:1px solid var(--border);font-size:0.8rem;font-weight:500;color:var(--text-secondary);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
    .pane-header-title{display:flex;align-items:center;gap:0.5rem}
    .pane-toggle{padding:0.3rem 0.6rem;border-radius:6px;font-size:0.75rem;cursor:pointer;transition:all 0.3s;background:var(--bg-card);border:1px solid var(--border);color:var(--text-muted);display:flex;align-items:center;gap:0.3rem}
    .pane-toggle:hover{border-color:var(--border-hover);color:var(--text-primary)}
    .pane-toggle.active{background:var(--primary-soft);border-color:var(--primary);color:var(--primary)}
    .pane-body{flex:1;overflow:auto}
    .markdown-editor{width:100%;height:100%;min-height:350px;padding:1.5rem;background:transparent;border:none;color:var(--text-primary);font-family:'Fira Code',monospace;font-size:0.9rem;line-height:1.8;resize:none;white-space:pre;overflow-x:auto}
    .markdown-editor:focus{outline:none}
    .preview-content{padding:1.5rem;font-family:'Noto Serif SC','Outfit',serif;font-size:0.95rem;line-height:1.8;overflow-x:auto}
    .preview-content pre{max-width:100%;overflow-x:auto}
    .preview-content img{max-width:100%}
    .preview-content table{display:block;overflow-x:auto;white-space:nowrap}
    @media(max-width:900px){.editor-body{flex-direction:column}.editor-pane{border-right:none;border-bottom:1px solid var(--border)}.editor-pane:last-child{border-bottom:none}}
    .preview-content h1,.preview-content h2,.preview-content h3{margin:1.5rem 0 0.75rem;font-family:'Outfit',sans-serif}
    .preview-content p{margin-bottom:1rem;color:var(--text-secondary)}
    .preview-content code{font-family:'Fira Code',monospace;background:var(--bg-card-hover);padding:0.15rem 0.4rem;border-radius:4px;font-size:0.85em}
    .preview-content pre{background:var(--bg-card-hover);border-radius:10px;padding:1rem;overflow-x:auto;margin:1rem 0}
    .preview-content pre code{background:none;padding:0}
    .preview-content blockquote{border-left:3px solid var(--primary);padding-left:1rem;margin:1rem 0;color:var(--text-muted);font-style:italic}
    .preview-content ul,.preview-content ol{margin:1rem 0;padding-left:1.5rem}
    .preview-content li{margin:0.35rem 0;color:var(--text-secondary)}
    .preview-content a{color:var(--primary)}
    .editor-actions{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:1rem;justify-content:flex-end;flex-wrap:wrap}
    .toast-container{position:fixed;top:80px;right:20px;z-index:1001;display:flex;flex-direction:column;gap:0.5rem}
    .toast{padding:1rem 1.5rem;border-radius:12px;background:var(--bg-card);border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,0.3);display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-color:var(--success);background:var(--success-soft)}
    .toast.error{border-color:var(--danger);background:var(--danger-soft)}
    .dialog-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all 0.3s}
    .dialog-overlay.active{opacity:1;visibility:visible}
    .dialog{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2rem;max-width:500px;width:90%;text-align:center}
    .dialog-icon{font-size:3rem;margin-bottom:1rem}
    .dialog-title{font-size:1.25rem;font-weight:600;margin-bottom:0.5rem}
    .dialog-text{color:var(--text-secondary);margin-bottom:1.5rem}
    .dialog-actions{display:flex;gap:1rem;justify-content:center}
    .instructions{background:var(--primary-soft);border:1px solid var(--border-hover);border-radius:12px;padding:1.5rem;margin-bottom:2rem}
    .instructions-title{font-weight:600;margin-bottom:0.75rem}
    .instructions-text{font-size:0.9rem;color:var(--text-secondary);line-height:1.7}
    .instructions-text a{color:var(--primary)}
    .instructions-text code{background:var(--bg-card);padding:0.15rem 0.4rem;border-radius:4px;font-family:'Fira Code',monospace;font-size:0.85em}
    /* Comments Management Styles */
    .comment-card{background:var(--bg-card-hover);border-radius:12px;padding:1.25rem;margin-bottom:1rem;border:1px solid var(--border)}
    .comment-card.pending{border-left:3px solid var(--warning)}
    .comment-card.approved{border-left:3px solid var(--success)}
    .comment-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem}
    .comment-author{font-weight:600}
    .comment-meta{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem}
    .comment-status{padding:0.25rem 0.6rem;border-radius:6px;font-size:0.7rem;font-weight:600}
    .comment-status.pending{background:var(--warning-soft);color:var(--warning)}
    .comment-status.approved{background:var(--success-soft);color:var(--success)}
    .comment-content{color:var(--text-secondary);margin-bottom:1rem;line-height:1.6}
    .comment-blog{font-size:0.8rem;color:var(--text-muted);margin-bottom:0.75rem}
    .comment-blog span{color:var(--primary)}
    .comment-actions{display:flex;gap:0.5rem;flex-wrap:wrap}
    .reply-indicator{font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;padding-left:1rem;border-left:2px solid var(--border)}
    .filter-bar{display:flex;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap}
    .filter-btn{padding:0.5rem 1rem;border-radius:8px;font-size:0.85rem;cursor:pointer;transition:all 0.3s;background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary)}
    .filter-btn:hover{border-color:var(--border-hover);color:var(--text-primary)}
    .filter-btn.active{background:var(--primary-soft);border-color:var(--primary);color:var(--primary)}
    .edit-dialog textarea{width:100%;min-height:120px;margin:1rem 0}
    @media(max-width:768px){.header-inner{padding:1rem}.main{padding:1rem}.auth-form{flex-direction:column}.form-group{min-width:100%}.tabs{flex-wrap:wrap}}
  </style>
</head>
<body>
  <div class="bg-gradient"></div>
  <header class="header">
    <div class="header-inner">
      <a href="./" class="logo"><div class="logo-icon">âš™ï¸</div><div class="logo-text">åšå®¢<span>ç®¡ç†</span></div></a>
      <div class="header-actions">
        <a href="./" class="btn btn-ghost">â† è¿”å›åšå®¢</a>
        <button class="theme-btn" id="themeToggle"><span id="themeIcon">ğŸŒ™</span></button>
      </div>
    </div>
  </header>
  <main class="main">
    <div class="instructions">
      <div class="instructions-title">ğŸ“‹ ä½¿ç”¨è¯´æ˜</div>
      <div class="instructions-text">
        <p>1. åœ¨ GitHub åˆ›å»º <a href="https://github.com/settings/tokens" target="_blank">Personal Access Token</a>ï¼Œéœ€è¦ <code>repo</code> æƒé™</p>
        <p>2. å¡«å†™ GitHub ç”¨æˆ·åã€ä»“åº“åå’Œ Tokenï¼Œç‚¹å‡»è¿æ¥</p>
        <p>3. è¿æ¥æˆåŠŸåå³å¯ç®¡ç†åšå®¢å’Œç•™è¨€ï¼Œæ•°æ®è‡ªåŠ¨åŒæ­¥åˆ° GitHub</p>
      </div>
    </div>
    <div class="auth-section">
      <div class="auth-title">ğŸ” GitHub è¿æ¥é…ç½®</div>
      <div class="auth-form">
        <div class="form-group"><label class="form-label">GitHub ç”¨æˆ·å</label><input type="text" class="form-input" id="githubUser" placeholder="your-username"></div>
        <div class="form-group"><label class="form-label">ä»“åº“å</label><input type="text" class="form-input" id="githubRepo" placeholder="your-repo"></div>
        <div class="form-group"><label class="form-label">Personal Access Token</label><input type="password" class="form-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx"></div>
        <button class="btn btn-primary" id="connectBtn">ğŸ”— è¿æ¥</button>
        <div class="auth-status disconnected" id="authStatus"><span>âšª</span> æœªè¿æ¥</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="blogs"><span>ğŸ“</span> æ–‡ç« ç®¡ç†</button>
      <button class="tab" data-tab="comments"><span>ğŸ’¬</span> ç•™è¨€ç®¡ç† <span class="tab-badge" id="pendingBadge">0</span></button>
    </div>
    
    <!-- Blog Management Tab -->
    <div class="tab-content active" id="blogsTab">
      <div class="panel-layout">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">ğŸ“„ æ–‡ç« åˆ—è¡¨</span>
            <button class="btn btn-primary btn-sm" id="newPostBtn">+ æ–°æ–‡ç« </button>
          </div>
          <div class="panel-body" id="blogList"><div class="empty-list"><div class="empty-list-icon">ğŸ“</div><p>æš‚æ— æ–‡ç« </p></div></div>
        </div>
        <div class="panel editor-panel">
          <div class="editor-header"><input type="text" class="editor-title-input" id="editorTitle" placeholder="æ–‡ç« æ ‡é¢˜"></div>
          <div class="editor-meta">
            <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="editorDate"></div>
            <div class="form-group"><label class="form-label">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input type="text" class="form-input tags-input" id="editorTags" placeholder="æŠ€æœ¯, ç”Ÿæ´»"></div>
          </div>
          <div class="editor-body" id="editorBody">
            <div class="editor-pane" id="editorPane">
              <div class="pane-header">
                <span class="pane-header-title">ğŸ“ Markdown ç¼–è¾‘</span>
                <button class="pane-toggle active" id="previewToggle">ğŸ‘ é¢„è§ˆ</button>
              </div>
              <div class="pane-body"><textarea class="markdown-editor" id="editorContent" placeholder="å¼€å§‹å†™ä½œ..."></textarea></div>
            </div>
            <div class="editor-pane" id="previewPane">
              <div class="pane-header">
                <span class="pane-header-title">ğŸ‘ å®æ—¶é¢„è§ˆ</span>
                <button class="pane-toggle" id="previewClose">âœ• å…³é—­</button>
              </div>
              <div class="pane-body"><div class="preview-content" id="previewContent"></div></div>
            </div>
          </div>
          <div class="editor-actions">
            <button class="btn btn-ghost" id="cancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-danger" id="deleteBtn" style="display:none">ğŸ—‘ åˆ é™¤</button>
            <button class="btn btn-primary" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Comments Management Tab -->
    <div class="tab-content" id="commentsTab">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">ğŸ’¬ ç•™è¨€ç®¡ç†</span>
        </div>
        <div style="padding:1.5rem">
          <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="pending">å¾…å®¡æ ¸</button>
            <button class="filter-btn" data-filter="approved">å·²é€šè¿‡</button>
          </div>
          <div id="commentsList"></div>
        </div>
      </div>
    </div>
  </main>
  
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- Delete Blog Dialog -->
  <div class="dialog-overlay" id="dialogOverlay">
    <div class="dialog">
      <div class="dialog-icon">âš ï¸</div>
      <div class="dialog-title">ç¡®è®¤åˆ é™¤</div>
      <div class="dialog-text">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ</div>
      <div class="dialog-actions">
        <button class="btn btn-ghost" id="dialogCancel">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="dialogConfirm">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Comment Dialog -->
  <div class="dialog-overlay" id="commentDialogOverlay">
    <div class="dialog">
      <div class="dialog-icon">âš ï¸</div>
      <div class="dialog-title">ç¡®è®¤åˆ é™¤ç•™è¨€</div>
      <div class="dialog-text">ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ</div>
      <div class="dialog-actions">
        <button class="btn btn-ghost" id="commentDialogCancel">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="commentDialogConfirm">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Comment Dialog -->
  <div class="dialog-overlay" id="editDialogOverlay">
    <div class="dialog edit-dialog">
      <div class="dialog-title">ç¼–è¾‘ç•™è¨€</div>
      <textarea class="form-input form-textarea" id="editCommentContent"></textarea>
      <div class="dialog-actions">
        <button class="btn btn-ghost" id="editDialogCancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="editDialogConfirm">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // Theme
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); themeIcon.textContent = 'ğŸŒ™'; }
    else { document.documentElement.setAttribute('data-theme', 'light'); themeIcon.textContent = 'â˜€ï¸'; }
    themeToggle.onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      if (current === 'dark') { document.documentElement.setAttribute('data-theme', 'light'); localStorage.setItem('theme', 'light'); themeIcon.textContent = 'â˜€ï¸'; }
      else { document.documentElement.setAttribute('data-theme', 'dark'); localStorage.setItem('theme', 'dark'); themeIcon.textContent = 'ğŸŒ™'; }
    };

    // Toast
    function toast(msg, type = 'success') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<span>${type === 'success' ? 'âœ“' : 'âœ•'}</span> ${msg}`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      };
    });

    // GitHub API
    const config = { user: '', repo: '', token: '', connected: false };
    const githubUser = document.getElementById('githubUser');
    const githubRepo = document.getElementById('githubRepo');
    const githubToken = document.getElementById('githubToken');
    const connectBtn = document.getElementById('connectBtn');
    const authStatus = document.getElementById('authStatus');

    // Load saved config
    githubUser.value = localStorage.getItem('gh_user') || '';
    githubRepo.value = localStorage.getItem('gh_repo') || '';
    githubToken.value = localStorage.getItem('gh_token') || '';

    const api = {
      base: () => `https://api.github.com/repos/${config.user}/${config.repo}/contents/`,
      headers: () => ({ 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' }),
      async get(path) {
        const r = await fetch(api.base() + path, { headers: api.headers() });
        if (!r.ok) throw new Error('API Error');
        return r.json();
      },
      async put(path, content, sha = null) {
        const body = { message: `Update ${path}`, content: btoa(unescape(encodeURIComponent(content))) };
        if (sha) body.sha = sha;
        const r = await fetch(api.base() + path, { method: 'PUT', headers: api.headers(), body: JSON.stringify(body) });
        if (!r.ok) throw new Error('API Error');
        return r.json();
      }
    };

    connectBtn.onclick = async () => {
      config.user = githubUser.value.trim();
      config.repo = githubRepo.value.trim();
      config.token = githubToken.value.trim();
      if (!config.user || !config.repo || !config.token) { toast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error'); return; }
      try {
        connectBtn.textContent = 'è¿æ¥ä¸­...';
        await fetch(`https://api.github.com/repos/${config.user}/${config.repo}`, { headers: api.headers() });
        config.connected = true;
        authStatus.className = 'auth-status connected';
        authStatus.innerHTML = '<span>ğŸŸ¢</span> å·²è¿æ¥';
        localStorage.setItem('gh_user', config.user);
        localStorage.setItem('gh_repo', config.repo);
        localStorage.setItem('gh_token', config.token);
        toast('è¿æ¥æˆåŠŸï¼');
        loadBlogs();
        loadComments();
      } catch (e) {
        toast('è¿æ¥å¤±è´¥', 'error');
        authStatus.className = 'auth-status disconnected';
        authStatus.innerHTML = '<span>ğŸ”´</span> è¿æ¥å¤±è´¥';
      }
      connectBtn.textContent = 'ğŸ”— è¿æ¥';
    };

    // Blog Management
    let blogs = [], fileSha = null, currentId = null;
    const blogList = document.getElementById('blogList');
    const editorTitle = document.getElementById('editorTitle');
    const editorDate = document.getElementById('editorDate');
    const editorTags = document.getElementById('editorTags');
    const editorContent = document.getElementById('editorContent');
    const previewContent = document.getElementById('previewContent');
    const newPostBtn = document.getElementById('newPostBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const dialogOverlay = document.getElementById('dialogOverlay');
    const dialogCancel = document.getElementById('dialogCancel');
    const dialogConfirm = document.getElementById('dialogConfirm');
    
    // é¢„è§ˆåˆ‡æ¢åŠŸèƒ½
    const editorPane = document.getElementById('editorPane');
    const previewPane = document.getElementById('previewPane');
    const previewToggle = document.getElementById('previewToggle');
    const previewClose = document.getElementById('previewClose');
    let previewVisible = true;

    function togglePreview(show) {
      previewVisible = show;
      if (show) {
        previewPane.classList.remove('hidden');
        editorPane.classList.remove('full-width');
        previewToggle.classList.add('active');
        previewContent.innerHTML = marked.parse(editorContent.value);
      } else {
        previewPane.classList.add('hidden');
        editorPane.classList.add('full-width');
        previewToggle.classList.remove('active');
      }
    }

    previewToggle.onclick = () => togglePreview(!previewVisible);
    previewClose.onclick = () => togglePreview(false);

    async function loadBlogs() {
      if (!config.connected) return;
      try {
        const data = await api.get('blog/data/blogs.json');
        fileSha = data.sha;
        blogs = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        renderList();
      } catch (e) { blogs = []; fileSha = null; renderList(); }
    }

    function renderList() {
      if (blogs.length === 0) { blogList.innerHTML = '<div class="empty-list"><div class="empty-list-icon">ğŸ“</div><p>æš‚æ— æ–‡ç« </p></div>'; return; }
      blogs.sort((a, b) => new Date(b.date) - new Date(a.date));
      blogList.innerHTML = blogs.map(b => `<div class="blog-list-item ${currentId === b.id ? 'active' : ''}" data-id="${b.id}"><div class="blog-list-title">${escapeHtml(b.title)}</div><div class="blog-list-meta">${b.date}</div></div>`).join('');
      blogList.querySelectorAll('.blog-list-item').forEach(el => { el.onclick = () => editBlog(el.dataset.id); });
    }

    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    editorContent.oninput = () => { if (previewVisible) previewContent.innerHTML = marked.parse(editorContent.value); };
    
    newPostBtn.onclick = () => {
      if (!config.connected) { toast('è¯·å…ˆè¿æ¥ GitHub', 'error'); return; }
      currentId = null;
      editorTitle.value = '';
      editorDate.value = new Date().toISOString().split('T')[0];
      editorTags.value = '';
      editorContent.value = '';
      previewContent.innerHTML = '';
      deleteBtn.style.display = 'none';
      renderList();
    };

    function editBlog(id) {
      const blog = blogs.find(b => b.id === id);
      if (!blog) return;
      currentId = id;
      editorTitle.value = blog.title;
      editorDate.value = blog.date;
      editorTags.value = (blog.tags || []).join(', ');
      editorContent.value = blog.content;
      previewContent.innerHTML = marked.parse(blog.content);
      deleteBtn.style.display = 'inline-flex';
      renderList();
    }

    cancelBtn.onclick = () => {
      currentId = null;
      editorTitle.value = '';
      editorDate.value = '';
      editorTags.value = '';
      editorContent.value = '';
      previewContent.innerHTML = '';
      deleteBtn.style.display = 'none';
      renderList();
    };

    saveBtn.onclick = async () => {
      if (!config.connected) { toast('è¯·å…ˆè¿æ¥ GitHub', 'error'); return; }
      const title = editorTitle.value.trim();
      const content = editorContent.value.trim();
      if (!title || !content) { toast('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º', 'error'); return; }
      const blog = { id: currentId || Date.now().toString(), title, date: editorDate.value || new Date().toISOString().split('T')[0], tags: editorTags.value.split(',').map(t => t.trim()).filter(t => t), content };
      if (currentId) { const idx = blogs.findIndex(b => b.id === currentId); if (idx !== -1) blogs[idx] = blog; }
      else { blogs.unshift(blog); }
      try {
        saveBtn.textContent = 'ä¿å­˜ä¸­...';
        const result = await api.put('blog/data/blogs.json', JSON.stringify(blogs, null, 2), fileSha);
        fileSha = result.content.sha;
        currentId = blog.id;
        toast('ä¿å­˜æˆåŠŸï¼');
        renderList();
        deleteBtn.style.display = 'inline-flex';
      } catch (e) { toast('ä¿å­˜å¤±è´¥', 'error'); }
      saveBtn.textContent = 'ğŸ’¾ ä¿å­˜';
    };

    deleteBtn.onclick = () => { dialogOverlay.classList.add('active'); };
    dialogCancel.onclick = () => { dialogOverlay.classList.remove('active'); };
    dialogConfirm.onclick = async () => {
      dialogOverlay.classList.remove('active');
      if (!currentId) return;
      blogs = blogs.filter(b => b.id !== currentId);
      try {
        const result = await api.put('blog/data/blogs.json', JSON.stringify(blogs, null, 2), fileSha);
        fileSha = result.content.sha;
        toast('åˆ é™¤æˆåŠŸï¼');
        cancelBtn.click();
      } catch (e) { toast('åˆ é™¤å¤±è´¥', 'error'); }
    };

    // Comments Management
    let allComments = {}, commentsSha = null, currentFilter = 'all';
    let deleteTarget = null, editTarget = null;
    const commentsList = document.getElementById('commentsList');
    const pendingBadge = document.getElementById('pendingBadge');
    const commentDialogOverlay = document.getElementById('commentDialogOverlay');
    const commentDialogCancel = document.getElementById('commentDialogCancel');
    const commentDialogConfirm = document.getElementById('commentDialogConfirm');
    const editDialogOverlay = document.getElementById('editDialogOverlay');
    const editDialogCancel = document.getElementById('editDialogCancel');
    const editDialogConfirm = document.getElementById('editDialogConfirm');
    const editCommentContent = document.getElementById('editCommentContent');

    async function loadComments() {
      if (!config.connected) return;
      try {
        const data = await api.get('blog/data/comments.json');
        commentsSha = data.sha;
        allComments = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        renderComments();
        updatePendingBadge();
      } catch (e) { allComments = {}; commentsSha = null; renderComments(); }
    }

    function updatePendingBadge() {
      let count = 0;
      Object.values(allComments).forEach(blogComments => {
        blogComments.forEach(c => {
          if (!c.approved) count++;
          (c.replies || []).forEach(r => { if (!r.approved) count++; });
        });
      });
      pendingBadge.textContent = count;
      pendingBadge.style.display = count > 0 ? 'inline' : 'none';
    }

    function getBlogTitle(blogId) {
      const blog = blogs.find(b => b.id === blogId);
      return blog ? blog.title : 'æœªçŸ¥æ–‡ç« ';
    }

    function renderComments() {
      let comments = [];
      Object.entries(allComments).forEach(([blogId, blogComments]) => {
        blogComments.forEach(c => {
          comments.push({ ...c, blogId, isReply: false });
          (c.replies || []).forEach(r => {
            comments.push({ ...r, blogId, parentId: c.id, parentAuthor: c.author, isReply: true });
          });
        });
      });

      // Sort by date descending
      comments.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Filter
      if (currentFilter === 'pending') comments = comments.filter(c => !c.approved);
      else if (currentFilter === 'approved') comments = comments.filter(c => c.approved);

      if (comments.length === 0) {
        commentsList.innerHTML = '<div class="empty-list"><div class="empty-list-icon">ğŸ’¬</div><p>æš‚æ— ç•™è¨€</p></div>';
        return;
      }

      commentsList.innerHTML = comments.map(c => `
        <div class="comment-card ${c.approved ? 'approved' : 'pending'}">
          <div class="comment-header">
            <div>
              <div class="comment-author">${escapeHtml(c.author)} ${c.email ? `<span style="font-weight:normal;color:var(--text-muted)">&lt;${escapeHtml(c.email)}&gt;</span>` : ''}</div>
              <div class="comment-meta">${c.date}</div>
            </div>
            <span class="comment-status ${c.approved ? 'approved' : 'pending'}">${c.approved ? 'å·²é€šè¿‡' : 'å¾…å®¡æ ¸'}</span>
          </div>
          <div class="comment-blog">æ–‡ç« ï¼š<span>${escapeHtml(getBlogTitle(c.blogId))}</span></div>
          ${c.isReply ? `<div class="reply-indicator">å›å¤ @${escapeHtml(c.parentAuthor)}</div>` : ''}
          <div class="comment-content">${escapeHtml(c.content)}</div>
          <div class="comment-actions">
            ${!c.approved ? `<button class="btn btn-success btn-sm" onclick="approveComment('${c.blogId}', '${c.id}', ${c.isReply})">âœ“ é€šè¿‡</button>` : ''}
            <button class="btn btn-warning btn-sm" onclick="openEditDialog('${c.blogId}', '${c.id}', ${c.isReply})">âœ ç¼–è¾‘</button>
            <button class="btn btn-danger btn-sm" onclick="openDeleteDialog('${c.blogId}', '${c.id}', ${c.isReply})">âœ• åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderComments();
      };
    });

    window.approveComment = async (blogId, commentId, isReply) => {
      const blogComments = allComments[blogId];
      if (!blogComments) return;

      if (isReply) {
        for (const c of blogComments) {
          const reply = (c.replies || []).find(r => r.id === commentId);
          if (reply) { reply.approved = true; break; }
        }
      } else {
        const comment = blogComments.find(c => c.id === commentId);
        if (comment) comment.approved = true;
      }

      await saveComments();
      toast('å·²å®¡æ ¸é€šè¿‡ï¼');
    };

    window.openDeleteDialog = (blogId, commentId, isReply) => {
      deleteTarget = { blogId, commentId, isReply };
      commentDialogOverlay.classList.add('active');
    };

    commentDialogCancel.onclick = () => { commentDialogOverlay.classList.remove('active'); };
    commentDialogConfirm.onclick = async () => {
      commentDialogOverlay.classList.remove('active');
      if (!deleteTarget) return;

      const { blogId, commentId, isReply } = deleteTarget;
      const blogComments = allComments[blogId];
      if (!blogComments) return;

      if (isReply) {
        for (const c of blogComments) {
          c.replies = (c.replies || []).filter(r => r.id !== commentId);
        }
      } else {
        allComments[blogId] = blogComments.filter(c => c.id !== commentId);
        if (allComments[blogId].length === 0) delete allComments[blogId];
      }

      await saveComments();
      toast('åˆ é™¤æˆåŠŸï¼');
      deleteTarget = null;
    };

    window.openEditDialog = (blogId, commentId, isReply) => {
      const blogComments = allComments[blogId];
      if (!blogComments) return;

      let content = '';
      if (isReply) {
        for (const c of blogComments) {
          const reply = (c.replies || []).find(r => r.id === commentId);
          if (reply) { content = reply.content; break; }
        }
      } else {
        const comment = blogComments.find(c => c.id === commentId);
        if (comment) content = comment.content;
      }

      editTarget = { blogId, commentId, isReply };
      editCommentContent.value = content;
      editDialogOverlay.classList.add('active');
    };

    editDialogCancel.onclick = () => { editDialogOverlay.classList.remove('active'); };
    editDialogConfirm.onclick = async () => {
      editDialogOverlay.classList.remove('active');
      if (!editTarget) return;

      const { blogId, commentId, isReply } = editTarget;
      const newContent = editCommentContent.value.trim();
      if (!newContent) { toast('å†…å®¹ä¸èƒ½ä¸ºç©º', 'error'); return; }

      const blogComments = allComments[blogId];
      if (!blogComments) return;

      if (isReply) {
        for (const c of blogComments) {
          const reply = (c.replies || []).find(r => r.id === commentId);
          if (reply) { reply.content = newContent; break; }
        }
      } else {
        const comment = blogComments.find(c => c.id === commentId);
        if (comment) comment.content = newContent;
      }

      await saveComments();
      toast('ä¿®æ”¹æˆåŠŸï¼');
      editTarget = null;
    };

    async function saveComments() {
      try {
        const result = await api.put('blog/data/comments.json', JSON.stringify(allComments, null, 2), commentsSha);
        commentsSha = result.content.sha;
        renderComments();
        updatePendingBadge();
      } catch (e) { toast('ä¿å­˜å¤±è´¥', 'error'); }
    }

    // Auto connect if saved
    if (githubUser.value && githubRepo.value && githubToken.value) {
      connectBtn.click();
    }
  </script>
</body>
</html>
